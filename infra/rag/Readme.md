> **rag_this is a quick python based RAG accelerator**  built from a combination of code based on [liamca/GPT4oContentExtraction: Using Azure OpenAI GPT 4o to extract information such as text, tables and charts from Documents to Markdown](https://github.com/liamca/GPT4oContentExtraction) and the **Content Understanding** sample code  from this repo: [Azure-Samples/azure-ai-content-understanding-python](https://github.com/Azure-Samples/azure-ai-content-understanding-python)
> 
> Input can be individual .docx or pdf files (other formats like pptx may work but have not been tested)  which will be parsed by Azure content understanding and then chunked into logically related sections based on headings and paragraphs.
> Once chunked, the chunks are stored in a folder and embedding is performed for vector indexing. Once embedding is complete the embedded chunks (stored in json file) are indexed in Azure AI Search.
When you attempt to index an existing document, this will be detected and ignored.

When calling the rag_this.py program, you can specify --keep_index to retain the specified index and append the document - default is False ( i.e. if you don't add the --keep_index parameter, the index will be dropped and re-created)
> The entire RAG pipeline process can be run locally on a workstation 
> build your RAG environment with: 
> python rag_this.py parameters:  sourcefile [--keep_index]

---

## Document to Markdown Converter (doc2md.py)

The `doc2md.py` utility is a standalone document conversion tool that extracts clean, structured markdown content from various document formats. It leverages Azure Content Understanding for advanced document parsing and supports multiple input formats with intelligent format detection.

### Features

#### **Multi-Format Support**
- **PDF files**: Advanced extraction using Azure Content Understanding
- **DOCX files**: Native conversion using python-docx and markdownify
- **Markdown files**: Direct copy with validation
- **Other formats**: Automatic fallback to Azure Content Understanding

#### **Azure Content Understanding Integration**
- **Intelligent document parsing**: Preserves document structure and formatting
- **Table extraction**: Maintains table structure in markdown format
- **Image handling**: Extracts and caches images from documents
- **Layout preservation**: Maintains headings, paragraphs, and document hierarchy

#### **Automated Processing**
- **Temporary analyzer creation**: Creates unique analyzers for each conversion
- **Automatic cleanup**: Removes temporary resources after processing
- **Error handling**: Comprehensive error logging and recovery
- **Batch processing ready**: Suitable for automation workflows

### Installation Requirements

Install the required dependencies:

```bash
pip install azure-identity pillow python-docx markdownify loguru
```

Ensure your Azure environment is configured with:
- Azure Content Understanding service
- Appropriate authentication (DefaultAzureCredential)
- Valid `config.json` with Azure AI endpoint configuration

### Configuration

The utility requires a `config.json` file in the parent directory with the following structure:

```json
{
    "azure_ai_endpoint": "https://your-ai-service.cognitiveservices.azure.com/",
    "azure_ai_api_version": "2024-12-01-preview"
}
```

### Usage

#### **Basic Syntax**
```bash
python doc2md.py <source_document> <target_directory>
```

#### **Parameters**
- `source_document`: Path to the input document (PDF, DOCX, MD, or other supported formats)
- `target_directory`: Directory where the output markdown file will be saved

#### **Output File Naming**
The output filename is automatically generated by appending `.md` to the source document's basename:
- Input: `document.pdf` → Output: `document.pdf.md`
- Input: `report.docx` → Output: `report.docx.md`
- Input: `existing.md` → Output: `existing.md.md`

### Usage Examples

#### **Example 1: Convert PDF to Markdown**
```bash
python doc2md.py "../documents/research_paper.pdf" "./markdown_output/"
```
**Result**: Creates `./markdown_output/research_paper.pdf.md` with structured markdown content

#### **Example 2: Convert DOCX to Markdown**
```bash
python doc2md.py "../reports/annual_report.docx" "./converted/"
```
**Result**: Creates `./converted/annual_report.docx.md` using native DOCX parsing

#### **Example 3: Copy Existing Markdown**
```bash
python doc2md.py "../content/readme.md" "./processed/"
```
**Result**: Copies the markdown file to `./processed/readme.md.md`

#### **Example 4: Batch Processing Script**
```bash
#!/bin/bash
# Convert all PDFs in a directory
for file in ../documents/*.pdf; do
    python doc2md.py "$file" "./markdown_output/"
done
```

#### **Example 5: Integration with RAG Pipeline**
```bash
# Step 1: Convert document to markdown
python doc2md.py "../source/policy_document.pdf" "./temp_md/"

# Step 2: Process with RAG system
python rag_this.py "./temp_md/policy_document.pdf.md" --keep_index
```

### Processing Behavior by File Type

#### **PDF Files (.pdf)**
- Uses Azure Content Understanding for advanced parsing
- Preserves complex layouts, tables, and document structure
- Extracts images and saves them to `.cache/` directory
- Handles multi-column layouts and complex formatting

#### **DOCX Files (.docx)**
- Uses python-docx for native document parsing
- Converts to markdown using markdownify library
- Preserves basic formatting and paragraph structure
- Faster processing compared to Azure Content Understanding

#### **Markdown Files (.md)**
- Direct file copy operation
- Validates file accessibility
- Maintains original formatting
- Instant processing

#### **Other Formats**
- Automatically uses Azure Content Understanding
- May work with PPTX, RTF, and other supported formats
- Processing success depends on Azure service capabilities

### Advanced Features

#### **Image Extraction and Caching**
```python
# Images are automatically extracted and saved
save_image(image_id, response)  # Saves to .cache/{image_id}.jpg
```

#### **Logging and Monitoring**
- Comprehensive logging to `../../logs/logs_{date}.log`
- Rotation and compression of log files
- Error tracking and debugging information
- Processing statistics and timing

#### **Error Handling**
- Graceful handling of authentication failures
- Network connectivity error recovery
- Invalid document format detection
- Resource cleanup on failure

### Troubleshooting

#### **Common Issues**

**Authentication Errors:**
```bash
# Ensure Azure CLI is logged in
az login

# Verify DefaultAzureCredential is working
az account show
```

**Missing Dependencies:**
```bash
# Install all required packages
pip install azure-identity pillow python-docx markdownify loguru
```

**Configuration Issues:**
- Verify `config.json` exists in the parent directory
- Check Azure AI endpoint URL is correct
- Ensure API version is supported

**Permission Errors:**
- Check target directory exists and is writable
- Verify source document is accessible
- Ensure sufficient disk space for output

#### **Debug Mode**
For troubleshooting, monitor the log files:
```bash
tail -f ../../logs/logs_$(date +%Y-%m-%d).log
```

### Integration with RAG System

The `doc2md.py` utility is designed to work seamlessly with the RAG pipeline:

1. **Document Conversion**: Convert source documents to clean markdown
2. **Content Preparation**: Markdown files are ideal for chunking and embedding
3. **RAG Processing**: Use converted markdown with `rag_this.py`
4. **Search Integration**: Markdown content integrates well with Azure AI Search

#### **Workflow Example**
```bash
# Convert multiple documents
python doc2md.py "policy1.pdf" "./md_files/"
python doc2md.py "policy2.docx" "./md_files/"
python doc2md.py "policy3.pdf" "./md_files/"

# Build RAG index with all converted documents
python rag_this.py "./md_files/" --keep_index
```

### Performance Considerations

#### **Processing Speed**
- **DOCX files**: Fastest (local processing)
- **Markdown files**: Instant (file copy)
- **PDF files**: Moderate (Azure API calls)
- **Complex documents**: Slower (detailed parsing)

#### **API Rate Limits**
- Azure Content Understanding has API rate limits
- Consider delays between batch processing calls
- Monitor API usage in Azure portal

#### **File Size Limits**
- PDF files: Limited by Azure Content Understanding service limits
- DOCX files: Limited by available memory
- Output size: Depends on document complexity and image content

### Best Practices

1. **Batch Processing**: Process documents in smaller batches to avoid rate limits
2. **Error Handling**: Always check log files for processing errors
3. **Storage Management**: Clean up `.cache/` directory periodically
4. **Authentication**: Ensure Azure credentials are valid before batch operations
5. **Testing**: Test with sample documents before processing large batches

---